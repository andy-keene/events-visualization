<html>
	<head>

		<!-- headers for maps -->
		<script src="https://www.amcharts.com/lib/3/ammap.js"></script>
		<script src="https://www.amcharts.com/lib/3/maps/js/worldLow.js"></script>
		<script src="https://www.amcharts.com/lib/3/plugins/export/export.min.js"></script>
		<link rel="stylesheet" href="https://www.amcharts.com/lib/3/plugins/export/export.css" type="text/css" media="all" />
		<script src="https://www.amcharts.com/lib/3/themes/light.js"></script>

		<!-- jquery -->
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

		<!-- headers for bootstrap -->
		<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" />
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>

		<!-- headers for chart.js -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>

		<!-- local js stuff-->
		<script src="/config.js"></script> 

		<!-- socket -->
		<script src="/socket.io/socket.io.js"></script>


		<style type="text/css">
			#chartdiv {
			  width: 80%;
			  height: 400px;
			  margin: auto;
			  border-radius: 3px;
			  border-style: fill;
			  border-width: 2px;
			  border-color: black;
			}						
		</style>
	</head>
	<body>
		<!--Navbar -->
	    <nav class="navbar navbar-default">
	      <div class="container-fluid">
	        <!-- Brand and toggle get grouped for better mobile display -->
	        <div class="navbar-header">
	          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
	            <span class="sr-only">Toggle navigation</span>
	            <span class="icon-bar"></span>
	            <span class="icon-bar"></span>
	            <span class="icon-bar"></span>
	          </button>
	          <a class="navbar-brand" href="#">ssh-events</a>
	        </div>
	        <!-- Collect the nav links, forms, and other content for toggling -->
	        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
	          <ul class="nav navbar-nav">
	            <li><a href="#home">Home </a></li>
	            <li><a href="#about">About</a></li>
	          </ul>
	        </div><!-- /.navbar-collapse -->
	      </div><!-- /.container-fluid -->
	    </nav><!-- /.Navbar -->
		
		<div class="container-fluid">
			
				<div class="row">
					<div class="col-md-12">
						<div id="chartdiv"></div>
					</div><!-- end animated map --> 
				</div> <!-- end row -->
				<div class="row">
					<div class="col-md-8 col-md-offset-2">
						<canvas id="myChart" ></canvas>
					</div><!-- end animated map --> 
				</div>
		</div><!-- end grid --> 
		

		<script type="text/javascript">

		var planeSVG = `m47.304248,31.588526l-3.694258,-0.099177l0.099855,3.669162c0.099855,5.950039 5.092134,10.809228 11.082868,11.007582l3.694258,0.099177l-0.099855,-3.669162c-0.199806,-5.950039 -5.092229,-10.908405 -11.082868,-11.007582z`;

		var map = AmCharts.makeChart("chartdiv", {
			"type": "map",
			"theme": "light",
			"areasSettings": {
					"unlistedAreasColor": "#8dd9ef"
			},
			"imagesSettings": {
				"color": "#585869",
				"rollOverColor": "#FF5869",
				"selectedColor": "#585869",
				"pauseDuration": 0.2,
				"animationDuration": 2.5,
				"adjustAnimationSpeed": true
			},
			"linesSettings": {
				"color": "#585869",
				"alpha": 0.4
			},
			"export": {
				"enabled": true
			},
			"listeners": [{
				"event": "init",
				"method": function(listenerEvent){
					console.log('init handler called');
				}
			}],
			"dataProvider": {
				"map": "worldLow",
				"lines": [{
			      "id": "animationLine",
			      "arc": -0.85,
			      "alpha": 0.3,
			      "latitudes": [],
			      "longitudes": []
			    }],
				"images": [{
			    	"id": "animationImage",
			      	"svgPath": planeSVG,
			     	"positionOnLine": 0,
			      	//"color": "#585869",
			      	"animateAlongLine": true,
			      	"lineId": "animationLine",	// this in needed for chart.validateData() to rerender the animation
			      	"scale": 0.5,
			      	"positionScale": 1.3,
			      	"listeners": [{
						"event": "animationEnd",
						"method": function(listenerEvent){
							console.log('animationFinished called in line');
							updateMapEvents(listenerEvent.chart);
						} 
					},
					{
						"event": "animationStart",
						"method": function(listenerEvent){
							console.log('animationStart called in line');
						}
					}]
				}]
			}, // end data provider			
		});

		//this is the object used to handle incoming events
		var globalEvents = {
			queue: [],
			//flag: false
		};

		//socket stuff
		var socket = io.connect('http://localhost:8080/');	//to be initialzed post render
		socket.on('event', function(eventData){
			//eventData should be exactly what is delievered to the server
			console.log('Socket recieved an event: ' + Object.keys(eventData));
			console.log([event.host_latitude, event.remote_latitude]);

			globalEvents.queue = [eventData].concat(globalEvents.queue);

			console.log(globalEvents.queue);
			//if not currently drawing, we need to kick it off
			if(!globalEvents.flag){
				globalEvents.flag = true;
				updateMapEvents(map);
			}
		});




		function updateMapEvents(chart){

			if(globalEvents.queue.length > 0){

				//update map to draw next event
				event = globalEvents.queue.pop();

				//set new line
				var animationLine = chart.getObjectById("animationLine");
				animationLine.latitudes = [event.host_latitude, event.remote_latitude];
				animationLine.longitudes = [event.host_longitude, event.remote_longitude];
				chart.validateData();

				//animate image
				var animationImage = chart.getObjectById("animationImage");
				animationImage.animateAlong("animationLine")

				console.log("calling animate plane...");
			}
			else {
				console.log("turning off flag")
				//end animation and reset flag
				globalEvents.flag = false;
			}
		}

		/* populate the data here */


		//Populate map with current data
	    jQuery.get({
	      url: '/events/locations',
	      dataType: "json",
	      success: function(response, status){
	          
	          if(!response.error){
	          	console.log('updating map');

	            response.events.forEach(function(event){
	            	
	            	var key = event.remote_longitude.toString() + event.remote_latitude.toString();
	            	map.dataProvider.images.push({
							"id": key,
							"type": "circle",
							"color": "#626AD2",
							"width": event.total_events > 11 ? 11: event.total_events,		//need to max the size somewhere
							"fixedSize": true,
						    "title": event.remote_city,
							"longitude": event.remote_longitude,
							"latitude": event.remote_latitude,
							//description is on click display of indormation
							"description": generateDescription(event),
							"descriptionWindowHeight": 150,
						  	"descriptionWindowWidth": 200,
						  	"descriptionWindowBottom": 15,
						  	"descriptionWindowLeft": 5
				    	});
	            });
	            map.validateData();
	            updateMapEvents(map);

			}
	      }
	    });
	    

	    //generates given events description
	    function generateDescription(event){
	    	return `
	    		   <div style="font-size:small;">
				   <b>Service</b>: ${event.service}<br>
				   <b>Connect events:</b> ${event.connect_events}<br>
				   <b>Reverse Mapping events:</b> ${event.reverse_mapping_events}<br>
				   <b>Password events:</b> ${event.password_events}<br>
				   See more here: <a href="/event?longitude=${event.remote_longitude}&latitude=${event.remote_latitude}" target="_blank">here</a>
				   </div>
				 `;
	    }

		</script>
	</body>
</html>