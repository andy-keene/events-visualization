<html>
	<head>

		<!-- headers for maps -->
		<script src="https://www.amcharts.com/lib/3/ammap.js"></script>
		<script src="https://www.amcharts.com/lib/3/maps/js/worldLow.js"></script>
		<script src="https://www.amcharts.com/lib/3/plugins/export/export.min.js"></script>
		<link rel="stylesheet" href="https://www.amcharts.com/lib/3/plugins/export/export.css" type="text/css" media="all" />
		<script src="https://www.amcharts.com/lib/3/themes/light.js"></script>

		<!-- jquery -->
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

		<!-- headers for bootstrap -->
		<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" />
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>

		<!-- headers for chart.js -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>

		<!-- local js stuff-->
		<script src="/config.js"></script> 

		<!-- socket -->
		<script src="/socket.io/socket.io.js"></script>


		<style type="text/css">
			#chartdiv {
			  width: 80%;
			  height: 750px;
			  margin: auto;
			  border-radius: 3px;
			  border-style: fill;
			  border-width: 2px;
			  border-color: black;
			}						
		</style>
	</head>
	<body>

		<!--Navbar -->
	    <nav class="navbar navbar-default">
	      <div class="container-fluid">
	        <!-- Brand and toggle get grouped for better mobile display -->
	        <div class="navbar-header">
	          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
	            <span class="sr-only">Toggle navigation</span>
	            <span class="icon-bar"></span>
	            <span class="icon-bar"></span>
	            <span class="icon-bar"></span>
	          </button>
	          <a class="navbar-brand" href="#">ssh-events</a>
	        </div>
	        <!-- Collect the nav links, forms, and other content for toggling -->
	        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
	          <ul class="nav navbar-nav">
	            <li><a href="#home">Home </a></li>
	            <li><a href="#about">About</a></li>
	          </ul>
	        </div><!-- /.navbar-collapse -->
	      </div><!-- /.container-fluid -->
	    </nav><!-- /.Navbar -->
		

		<div class="container-fluid">
			
				<div class="row">
					<div class="col-md-12">
						<!-- eventMap panel -->
					 	<div class="panel panel-default">
	                        <div class="panel-heading">
	                            <i class="fa fa-bar-chart-o fa-fw"></i> Geodata
	                            <div class="pull-right">
	                                <div class="btn-group">
	                                    <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown">
	                                        Actions
	                                        <span class="caret"></span>
	                                    </button>
	                                    <ul class="dropdown-menu pull-right" role="menu">
	                                        <li><a href="#">turn on map export</a>
	                                        </li>
	                                        <li><a href="#">turn off map export</a>
	                                        </li>
	                                        <li><a href="#">turn off live streaming</a>
	                                        </li>
	                                        <li class="divider"></li>
	                                        <li><a href="#">Separated link</a>
	                                        </li>
	                                    </ul>
	                                </div>
	                            </div>
	                        </div>

                        <!-- /.panel-heading -->
                        <div class="panel-body">
                            <div id="chartdiv"></div>
                        </div>
                        <!-- /.panel-body -->
                    </div>
                    <!-- /.panel -->
				</div> <!-- end col -->
				</div> <!-- end row -->
				<div class="row">
					<div class="col-md-8 col-md-offset-2">
						<canvas id="myChart" ></canvas>
					</div><!-- end animated map --> 
				</div>
		</div><!-- end grid --> 
		

		<script type="text/javascript">

		var config = {
			"serviceColors": {
				"telnet": "#2E696A",
				"ssh": "#626AD2"
			}
		};

		var planeSVG = `m47.304248,31.588526l-3.694258,-0.099177l0.099855,3.669162c0.099855,5.950039 5.092134,10.809228 11.082868,11.007582l3.694258,0.099177l-0.099855,-3.669162c-0.199806,-5.950039 -5.092229,-10.908405 -11.082868,-11.007582z`;

		var targetSVG = "M9,0C4.029,0,0,4.029,0,9s4.029,9,9,9s9-4.029,9-9S13.971,0,9,0z M9,15.93 c-3.83,0-6.93-3.1-6.93-6.93S5.17,2.07,9,2.07s6.93,3.1,6.93,6.93S12.83,15.93,9,15.93 M12.5,9c0,1.933-1.567,3.5-3.5,3.5S5.5,10.933,5.5,9S7.067,5.5,9,5.5 S12.5,7.067,12.5,9z";

		var eventMap = AmCharts.makeChart("chartdiv", {
			"type": "map",
			"theme": "light",
			"areasSettings": {
				"unlistedAreasColor": "#8dd9ef"
			},
			"imagesSettings": {
				"color": "#585869",
				"rollOverColor": "#FF5869",
				"selectedColor": "#585869",
				"pauseDuration": 0.2,
				"animationDuration": 2.5,
				"adjustAnimationSpeed": true
			},
			"linesSettings": {
				"color": "#585869",
				"alpha": 0.4
			},
			"export": {
				"enabled": true
			},
			"listeners": [{
				"event": "init",
				"method": function(listenerEvent){
					console.log('init handler called');
				}
			}],
			"dataProvider": {
				"map": "worldLow",
				"lines": [{
			      "id": "animationLine",
			      "arc": -0.85,
			      "alpha": 0.3,
			      "latitudes": [],
			      "longitudes": []
			    }],
				"images": [{
			    	"id": "animationImage",
			      	"svgPath": planeSVG,
			     	"positionOnLine": 0,
			      	//"color": "#585869",
			      	"animateAlongLine": true,
			      	"lineId": "animationLine",	// this in needed for chart.validateData() to rerender the animation
			      	"scale": 0.5,
			      	"positionScale": 1.3,
			      	"listeners": [{
						"event": "animationEnd",
						"method": function(listenerEvent){
							console.log('animationFinished called in line');
							updateMapEvents(listenerEvent.chart);
						} 
					},
					{
						"event": "animationStart",
						"method": function(listenerEvent){
							console.log('animationStart called in line');
						}
					}]
				}]
			}, // end data provider			
		});

		//this is the object used to handle incoming socket events
		var globalEvents = {
			queue: [],
			flag: false
		};

		//socket stuff
		var socket = io.connect('http://localhost:8080/',);	//to be initialzed post render
		socket.on('event', function(eventData){
			//eventData should be exactly what is delievered to the server
			console.log('Socket recieved an event: ' + Object.keys(eventData));
			console.log([event.host_latitude, event.remote_latitude]);

			globalEvents.queue = [eventData].concat(globalEvents.queue);

			console.log(globalEvents.queue);
			//if not currently drawing, we need to kick it off
			if(!globalEvents.flag){
				globalEvents.flag = true;
				updateMapEvents(eventMap);
			}
		});
		socket.on('connect_error', function(eventData){
			alert('failed to connect to live stream');
			//socket.close();
		});




		function updateMapEvents(map){

			if(globalEvents.queue.length > 0){
				//update map to draw next event
				event = globalEvents.queue.pop();

				//adds/updates the images to the map
				addLocationImages(map, event);

				//set new line for event
				var animationLine = map.getObjectById("animationLine");
				animationLine.latitudes = [event.remote_latitude, event.host_latitude];
				animationLine.longitudes = [event.remote_longitude, event.host_longitude];
				map.validateData();

				//kick-off animattion of image along line
				var animationImage = map.getObjectById("animationImage");
				animationImage.animateAlong("animationLine")

				console.log("calling animate plane...");
			}
			else {
				console.log("turning off flag")
				//end animation and reset flag
				globalEvents.flag = false;
			}
		}

		/* populate the data here */


		//Populate map with current data
	    jQuery.get({
	      url: '/events/locations',
	      dataType: "json",
	      success: function(response, status){
	          
	          if(!response.error){
	          	console.log('updating map');

	            response.events.forEach(function(event){
	            	addLocationImages(eventMap, event);
	            });
	            eventMap.validateData();
	            updateMapEvents(eventMap);
			}
	      }
	    });


	    //Adds images for the given events host and remote locations if they do not exist,
	    //otherwise updates them
	    function addLocationImages(map, event){
	    	//id images by "<longitude><latitude>"
	    	var remoteKey = event.remote_longitude.toString() + event.remote_latitude.toString();
	    	var hostKey = event.host_longitude.toString() + event.host_latitude.toString();;
	        
	        if(!map.getObjectById(remoteKey)){
	        	map.dataProvider.images.push({
							"id": remoteKey,
							"type": "circle",
							"color": config.serviceColors[event.service],
							"width": event.total_events > 15 ? 15: event.total_events,		// the || is incase it is null from say a socket event.
							"fixedSize": true,
						    "title": event.remote_city,
							"longitude": event.remote_longitude,
							"latitude": event.remote_latitude,
							//description is on click display of indormation
							"description": `<div style="font-size:small;">
										   <b>Services</b>: ${event.services}<br>
										   <b>Number of events:</b> ${event.total_events}<br>
										   See more events originating from this location 
										   <a href="/event?longitude=${event.remote_longitude}&latitude=${event.remote_latitude}" target="_blank">here</a>
										   </div>`,
							"descriptionWindowHeight": 150,
						  	"descriptionWindowWidth": 200,
						  	"descriptionWindowBottom": 15,
						  	"descriptionWindowLeft": 10,
						  	//these are local storage for us. 
						  	//"events": event.total_events || 1,
						  	"services": event.services
				});
			} else {
				//this may be taken out, but updates the relevant image information with the new attack info.
				let remoteLocationImage = map.getObjectById(remoteKey);
				remoteLocationImage["color"] = config.serviceColors[event.service];
				remoteLocationImage["width"] = event.total_events > 11 ? 11: event.total_events;
				remoteLocationImage["services"] = event.services;
				remoteLocationImage["description"] = `<div style="font-size:small;">
													   <b>Services</b>: ${event.services}<br>
													   <b>Number of events:</b> ${event.total_events}<br>
													   See more events originating from this location 
													   <a href="/event?longitude=${event.remote_longitude}&latitude=${event.remote_latitude}" target="_blank">here</a>
													   </div>`;
			}
	    }
	    

		</script>
	</body>
</html>